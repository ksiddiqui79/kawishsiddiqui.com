<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Redshift QMR Notification Utility - Kawish Siddiqui</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility", url: "#_top", children: [
              {title: "Goals", url: "#goals" },
              {title: "Installation Notes:", url: "#installation-notes" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-143819065-1', 'kawishsiddiqui.com');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Vacclyze/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Vacclyze/" class="btn btn-xs btn-link">
        Redshift Vacuum Analyze
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../encrypt_decrypt_udf_using_pyaes/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../encrypt_decrypt_udf_using_pyaes/" class="btn btn-xs btn-link">
        Redshift Encryption UDF
      </a>
    </div>
    
  </div>

    

    <h1 id="amazon-redshift-wlm-query-monitoring-rule-qmr-action-notification-utility">Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility</h1>
<h2 id="goals">Goals</h2>
<p>This utility uses a scheduled Lambda function to pull records from the QMR action system log table (<code>stl_wlm_rule_action</code>) and publish them to an SNS topic. This utility can be used to send periodic notifications based on the WLM query monitoring rule actions taken for your unique workload and rules configuration.</p>
<p>In Amazon Redshift workload management (WLM), query monitoring rules define metrics-based performance boundaries for WLM queues and specify what action to take when a query goes beyond those boundaries. For example, for a queue dedicated to short running queries, you might create a rule that aborts queries that run for more than 60 seconds. To track poorly designed queries, you might have another rule that logs queries that contain nested loops.  The rule actions are captured in <code>stl_wlm_rule_action</code> system table. For more information about Redshift workload management (WLM) query monitoring rules and how to configure it, please refer to Redshift <a href="http://docs.aws.amazon.com/redshift/latest/mgmt/workload-mgmt-config.html">Documentation</a></p>
<p>The utility periodically scans <code>stl_wlm_rule_action.actions</code> (log/hop/abort) recorded by WLM query monitoring rules and sends the records as SNS notifications. In summary, a Lambda function is invoked on a scheduled interval, connects to your Redshift cluster, reads events from <code>stl_wlm_rule_action</code> and publishes them to an SNS topic as a JSON string.</p>
<h2 id="installation-notes">Installation Notes:</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>This utility requires the following items:</p>
<ul>
<li>
<p>VPC: A VPC which currently contains your Amazon Redshift resource and will contain this utility's Lambda function. <strong><em>NOTE: VPC ID</em></strong></p>
</li>
<li>
<p>Private Subnets with NAT route: At least two private subnets within that VPC with private routes to the target Amazon Redshift cluster. You should have a NAT Gateway to give access to the Internet for those subnets' routing tables. You cannot use public subnets. You can read more information on this Lambda requirement here: <a href="https://aws.amazon.com/blogs/aws/new-access-resources-in-a-vpc-from-your-lambda-functions/">AWS blog</a>. <strong><em>NOTE: Subnet IDs</em></strong></p>
</li>
<li>
<p>Security Group: A VPC security group which allows the Lambda function access to your Amazon Redshift cluster on the port specified for SQL connections. <strong><em>NOTE: VPC Security Group ID</em></strong></p>
</li>
<li>
<p>An Amazon Redshift cluster in the above VPC. <strong><em>NOTE: Amazon Redshift cluster's Endpoint, Port, Database</em></strong></p>
</li>
<li>
<p>Database user credentials for an Amazon Redshift user with access to <a href="http://docs.aws.amazon.com/redshift/latest/dg/r_STL_WLM_RULE_ACTION.html"><code>STL_WLM_RULE_ACTION</code></a>. A superuser will be able to see all rows in this table, and a non-privileged user will be able to see only their own rows. More on visibility here: <a href="http://docs.aws.amazon.com/redshift/latest/dg/c_visibility-of-data.html">Visibility of Data in System Tables and Views</a>. <strong><em>NOTE: Amazon Redshift cluster's user name and password</em></strong></p>
</li>
<li>
<p>An active WLM configuration with QMR enabled (<a href="http://docs.aws.amazon.com/redshift/latest/mgmt/workload-mgmt-config.html">Documentation</a>).</p>
</li>
<li>
<p>Access to an IAM user with privileges to create and modify the necessary CloudFormation, KMS, IAM, SNS, and CloudWatch Events resources.</p>
</li>
<li>
<p>A locally cloned amazon-redshift-utils project containing this utility and AWS CLI and/or AWS Console access. </p>
</li>
</ul>
<h3 id="installation-from-cloudformation-template">Installation from CloudFormation Template:</h3>
<p>The quickest way to get up and running with the QMRNotificationUtility is by leveraging the packaged CloudFormation template and the AWS CLI.</p>
<h4 id="1-navigate-to-the-qmrnotificationutilitys-directory-within-the-amazon-redshift-utils-project">1. Navigate to the QMRNotificationUtility's directory within the amazon-redshift-utils project:</h4>
<pre><code>git clone/pull amazon-redshift-utils
cd amazon-redshift-utils/src/QMRNotificationUtility
</code></pre>

<h4 id="2-copy-the-zipped-python-deployment-package-for-the-lambda-function-to-a-location-of-your-choosing-in-s3">2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:</h4>
<pre><code class="bash">aws s3 cp ./lambda/dist/qmr-action-notification-utility-1.4.zip s3://yourbucket/qmr-action-notification-utility-1.4.zip
</code></pre>

<h4 id="3-gather-the-necessary-identifiers-noted-in-the-prerequistes-section-above">3. Gather the necessary identifiers noted in the prerequistes section above:</h4>
<ul>
<li>VPC ID</li>
<li>Subnet ID(s)</li>
<li>Security Group ID(s)</li>
<li>Cluster Endpoint</li>
<li>Cluster Port</li>
<li>Cluster Database</li>
<li>Cluster Credentials (Username and Password)</li>
<li>Bucket to host the Lambda Deployment Package</li>
<li>Email address to be notified of WLM actions</li>
</ul>
<h4 id="4-create-the-lambda-function">4. Create the Lambda Function</h4>
<p>Use the AWS CLI to create a stack containing the necessary dependencies and Lambda function:</p>
<pre><code class="bash">aws cloudformation create-stack \
--stack-name qmr-action-notification-utility \
--template-body file://./cloudformation/qmr-action-notification-utility.yaml \
--parameters \
  ParameterKey=S3Bucket,ParameterValue=yourbucket \
  ParameterKey=S3Key,ParameterValue=qmr-action-notification-utility-1.4.zip \
  ParameterKey=SNSEmailParameter,ParameterValue=test@email.com \
  ParameterKey=VPC,ParameterValue=vpc-abcd1234 \
  ParameterKey=SubnetIds,ParameterValue=subnet-abcd1234 \
  ParameterKey=SecurityGroupIds,ParameterValue=sg-abcd1234 \
  ParameterKey=RedshiftMonitoringUser,ParameterValue=monitoring_user \
  ParameterKey=RedshiftClusterPort,ParameterValue=cluster_port \
  ParameterKey=RedshiftClusterEndpoint,ParameterValue=examplecluster.abcd12340987.us-east-1.redshift.amazonaws.com \
  ParameterKey=RedshiftClusterDatabase,ParameterValue=db_name \
  ParameterKey=MonitoringDBPasswordCiphertext,ParameterValue= \
--capabilities CAPABILITY_IAM
</code></pre>

<h4 id="5-verify-creation-is-complete">5. Verify creation is complete</h4>
<p>It may take a few mintues for the stack's resources to be provisioned, and is completed when the following command returns "CREATE_COMPLETE":</p>
<pre><code class="bash">aws cloudformation describe-stacks --stack-name qmr-action-notification-utility --query 'Stacks[0].StackStatus' --output text
</code></pre>

<h4 id="6-add-an-encrypted-password">6. Add an encrypted password</h4>
<p>From the completed stack creation, extract the KMS Key ID, and use that Key to process your plaintext database password to ciphertext:</p>
<pre><code class="bash"># Extract KMS Key ID
KMSKEYID=`aws cloudformation describe-stack-resource --stack-name qmr-action-notification-utility --logical-resource-id RedshiftKMSKey --query 'StackResourceDetail.PhysicalResourceId' --output text`
# Generate a read restricted local file to store your plaintext password
(umask 077; touch passwd.txt)
# Insert your plaintext password into file. If using vi ensure binary mode and no automatic EOL
vi -b -c 'set noeol' passwd.txt
# Read plaintext password file contents into kms encrypt to generate ciphertext
CIPHERTEXT=`aws kms encrypt --key-id $KMSKEYID --plaintext file://./passwd.txt --query 'CiphertextBlob' --output text`
# Cleanup password file
rm passwd.txt
</code></pre>

<h4 id="7-update-your-cloudformation-stack">7. Update your CloudFormation stack</h4>
<p>Add the <code>MonitoringDBPasswordCiphertext</code> parameter with the ciphertext generated from the previous step, leaving all other parameters unchanged:</p>
<pre><code class="bash">aws cloudformation update-stack \
--stack-name qmr-action-notification-utility \
--use-previous-template \
--parameters \
  ParameterKey=MonitoringDBPasswordCiphertext,ParameterValue=$CIPHERTEXT \
  ParameterKey=S3Bucket,UsePreviousValue=true \
  ParameterKey=S3Key,UsePreviousValue=true \
  ParameterKey=SNSEmailParameter,UsePreviousValue=true \ 
  ParameterKey=VPC,UsePreviousValue=true \
  ParameterKey=SubnetIds,UsePreviousValue=true \
  ParameterKey=SecurityGroupIds,UsePreviousValue=true \
  ParameterKey=RedshiftMonitoringUser,UsePreviousValue=true \
  ParameterKey=RedshiftClusterPort,UsePreviousValue=true \
  ParameterKey=RedshiftClusterEndpoint,UsePreviousValue=true \
  ParameterKey=RedshiftClusterDatabase,UsePreviousValue=true \
--capabilities CAPABILITY_IAM
</code></pre>

<h4 id="8-verify-the-modification-is-complete">8. Verify the modification is complete</h4>
<p>It may take a moment for the stack's resources to be updated, and is done when the following command returns "UPDATE_COMPLETE":</p>
<pre><code class="bash">aws cloudformation describe-stacks --stack-name qmr-action-notification-utility --query 'Stacks[0].StackStatus' --output text
</code></pre>

<h4 id="9-check-the-inbox-of-the-email-address-you-included-for-snsemailparameter">9. Check the inbox of the email address you included for SNSEmailParameter.</h4>
<p>There should be an "AWS Notification - Subscription Confirmation" from no-reply@sns.amazonaws.com asking that you confirm your subscription. Click the link if you wish to receive updates on this email address.  </p>
<h4 id="10-verify-the-email-address-receives-an-email-notification-within-5-minutes">10. Verify the email address receives an email notification within 5 minutes</h4>
<p>By purposely triggering a QMR action by manually running SQL that is known to violate a rule defined in your active WLM configuration. Below is one example SNS notification email message:</p>
<pre><code class="json">[
  {
     &quot;clusterid&quot;:&quot;examplecluster&quot;,
     &quot;database&quot;:&quot;dev&quot;,
     &quot;userid&quot;:100,
     &quot;query&quot;:1186777,
     &quot;service_class&quot;:6,
     &quot;rule&quot;:&quot;Rule1_Nested_Loop&quot;,
     &quot;action&quot;:&quot;abort&quot;,
     &quot;recordtime&quot;:&quot;2017-06-12T06:51:57.167052&quot;
  },
  {
      &quot;clusterid&quot;:&quot;examplecluster&quot;,
      &quot;database&quot;:&quot;dev&quot;,
      &quot;userid&quot;:100,
      &quot;query&quot;:1186999,
      &quot;service_class&quot;:6,
      &quot;rule&quot;:&quot;Rule2_high_Return_Rows&quot;,
      &quot;action&quot;:&quot;log&quot;,
      &quot;recordtime&quot;:&quot;2017-06-12T06:53:48.935375&quot;
   }
]
</code></pre>

<h3 id="rebuilding-lambda-function">Rebuilding Lambda Function</h3>
<p>If you wish to rebuild the Lambda function yourself, you can use <code>lambda/build.sh</code> to create a zipped Deployment Package to upload to your S3 bucket. This utility requires <code>pip</code> and <code>virtualenv</code> python dependencies. This script will initialize a transient virtual environment, download python dependencies from <code>requirements.txt</code>, and zip the lambda function source code with dependencies into a versioned archive for uploading to S3.</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Vacclyze/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Vacclyze/" class="btn btn-xs btn-link">
        Redshift Vacuum Analyze
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../encrypt_decrypt_udf_using_pyaes/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../encrypt_decrypt_udf_using_pyaes/" class="btn btn-xs btn-link">
        Redshift Encryption UDF
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/ksiddiqui79/repository/edit/master/docs/redshift/RedshiftQMRActvtMon.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>